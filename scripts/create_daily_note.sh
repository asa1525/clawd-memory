#!/bin/bash
# Obsidian Daily Note Creator (API version)
# Runs daily at 8:30 AM
# Creates new note via Fast Note Sync API

# Configuration
MEMORY_FILE="/root/.openclaw/workspace/MEMORY.md"
TODAY=$(date +%Y-%m-%d)
FASTNOTE_URL="http://127.0.0.1:9000"
CREDENTIALS="asa1525:a9940710"

# Login to Fast Note Sync
login_fastnote() {
    local response=$(curl -s "${FASTNOTE_URL}/api/user/login" \
        -X POST \
        -d "credentials=${CREDENTIALS}")
    echo "$response" | grep -o '"token":"[^"]*"' | cut -d'"' -f4
}

# Extract todos from MEMORY.md
get_todos() {
    echo "## ğŸ“‹ å¾…åŠäº‹é¡¹"
    echo ""
    echo "### ğŸ”„ æŒç»­è¿›è¡Œ"
    if [ -f "$MEMORY_FILE" ]; then
        grep -A 30 "å¾…åŠè¿½è¸ª" "$MEMORY_FILE" 2>/dev/null | grep "^- " | sed 's/^- /- [ ] /' | head -10
    fi
    echo ""
    echo "### ğŸ’¼ å·¥ä½œä»»åŠ¡"
    echo "- [ ] ä¸ Chapin è·Ÿè¿›æ•°æ®ä¸­å°é¡¹ç›®è¿›å±•"
    echo "- [ ] è”ç³»æ·±åœ³ office çœ‹æˆ¿éœ€æ±‚åé¦ˆ"
    echo "- [ ] è·Ÿè¿› SAP æ¥å£å¼€å‘éœ€æ±‚ç¡®è®¤"
    echo "- [ ] ç”¨å‹äº‘ç«¯é¡¹ç›®è¿›åº¦è·Ÿè¿›"
    echo "- [ ] GP% Dashboard å¼€å‘ï¼ˆç­‰å¾… Ken æä¾›å†å²æ•°æ®ï¼‰"
    echo "- [ ] AR Dashboard å¼€å‘ï¼ˆç­‰å¾…æ±‡ç‡æ•°æ®ï¼‰"
    echo ""
    echo "### ğŸ“Š è‚¡ç¥¨ç›‘æ§"
    echo "- [ ] æ£€æŸ¥æ¯æ—¥è‚¡ç¥¨åˆ†ææ¨é€"
    echo ""
}

# Get next note ID
get_next_note_id() {
    local response=$(curl -s "${FASTNOTE_URL}/api/note?vault=Obsidian%20Vault&path=n_1.md" \
        -H "Authorization: Bearer $(login_fastnote)" 2>/dev/null)
    
    # If n_1.md exists, find max ID
    if echo "$response" | grep -q '"code":1'; then
        # Find max ID by listing notes
        local max_id=0
        for i in $(seq 1 1000); do
            local check=$(curl -s "${FASTNOTE_URL}/api/note?vault=Obsidian%20Vault&path=n_${i}.md" \
                -H "Authorization: Bearer $(login_fastnote)" 2>/dev/null)
            if echo "$check" | grep -q '"code":430'; then
                break
            fi
            max_id=$i
        done
        echo $((max_id + 1))
    else
        echo "1"
    fi
}

# Check if today's note exists
check_today_note() {
    local response=$(curl -s "${FASTNOTE_URL}/api/note/list?vault=Obsidian%20Vault&limit=100" \
        -H "Authorization: Bearer $(login_fastnote)" 2>/dev/null)
    
    # Look for today's note
    if echo "$response" | grep -q "${TODAY}"; then
        echo "found"
    else
        echo "new"
    fi
}

# Create or update note via API
create_or_update_note() {
    local token=$(login_fastnote)
    local today_note_id=""
    
    # Check for existing notes
    local response=$(curl -s "${FASTNOTE_URL}/api/note/list?vault=Obsidian%20Vault&limit=100" \
        -H "Authorization: Bearer $token" 2>/dev/null)
    
    # Find max ID
    local max_id=0
    for i in $(seq 1 1000); do
        local check=$(curl -s "${FASTNOTE_URL}/api/note?vault=Obsidian%20Vault&path=n_${i}.md" \
            -H "Authorization: Bearer $token" 2>/dev/null)
        if echo "$check" | grep -q '"code":430'; then
            break
        fi
        max_id=$i
    done
    
    local next_id=$((max_id + 1))
    
    # Generate content
    local content="# ${TODAY}

## ğŸ¯ ä»Šæ—¥é‡ç‚¹

### Morning Review
- [ ] å›é¡¾æ˜¨æ—¥å¾…åŠå®Œæˆæƒ…å†µ
- [ ] æŸ¥çœ‹è‚¡ç¥¨åˆ†ææ¨é€
- [ ] ç¡®è®¤å½“æ—¥ä¼šè®®å®‰æ’

$(get_todos)

### ğŸ“… ä¼šè®®å®‰æ’
å¾…è¡¥å……...

### ğŸ’¡ ä»Šæ—¥çµæ„Ÿ/æƒ³æ³•
å¾…è¡¥å……...

---
*Generated by OpenClaw Auto-Note @ $(date '+%Y-%m-%d %H:%M')*"

    # Create new note via API
    local result=$(curl -s "${FASTNOTE_URL}/api/note" \
        -X POST \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "vault=Obsidian Vault" \
        -d "path=n_${next_id}.md" \
        -d "content=$content")
    
    if echo "$result" | grep -q '"code":1'; then
        echo "âœ… Created: n_${next_id} for ${TODAY}"
    else
        echo "âŒ Failed to create note: $result"
    fi
}

# Main
create_or_update_note
