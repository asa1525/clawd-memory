#!/bin/bash
# Obsidian Daily Note Creator with Todo List
# Runs daily at 8:30 AM

# Configuration
OBSIDIAN_VAULT="$HOME/.openclaw/workspace/storage/vault/u_1/note"
MEMORY_FILE="/root/.openclaw/workspace/MEMORY.md"
TODAY=$(date +%Y-%m-%d)

# Extract todos from MEMORY.md
get_todos() {
    echo "## ğŸ“‹ å¾…åŠäº‹é¡¹"
    echo ""
    echo "### ğŸ”„ æŒç»­è¿›è¡Œ"
    if [ -f "$MEMORY_FILE" ]; then
        grep -A 20 "å¾…åŠè¿½è¸ª" "$MEMORY_FILE" 2>/dev/null | grep "^- " | sed 's/^- /- [ ] /' | head -10
    fi
    echo ""
    echo "### ğŸ’¼ å·¥ä½œä»»åŠ¡"
    echo "- [ ] ä¸ Chapin è·Ÿè¿›æ•°æ®ä¸­å°é¡¹ç›®è¿›å±•"
    echo "- [ ] è”ç³»æ·±åœ³ office çœ‹æˆ¿éœ€æ±‚åé¦ˆ"
    echo "- [ ] è·Ÿè¿› SAP æ¥å£å¼€å‘éœ€æ±‚ç¡®è®¤"
    echo "- [ ] ç”¨å‹äº‘ç«¯é¡¹ç›®è¿›åº¦è·Ÿè¿›"
    echo "- [ ] GP% Dashboard å¼€å‘ï¼ˆç­‰å¾… Ken æä¾›å†å²æ•°æ®ï¼‰"
    echo "- [ ] AR Dashboard å¼€å‘ï¼ˆç­‰å¾…æ±‡ç‡æ•°æ®ï¼‰"
    echo ""
    echo "### ğŸ“Š è‚¡ç¥¨ç›‘æ§"
    echo "- [ ] æ£€æŸ¥æ¯æ—¥è‚¡ç¥¨åˆ†ææ¨é€"
    echo ""
}

# Find next available note number
find_next_note() {
    local max_num=0
    for dir in "$OBSIDIAN_VAULT"/n_*; do
        if [ -d "$dir" ]; then
            local num=$(basename "$dir" | sed 's/n_//')
            if [ "$num" -gt "$max_num" ] 2>/dev/null; then
                max_num=$num
            fi
        fi
    done
    echo $((max_num + 1))
}

# Create the daily note
create_note() {
    local content="# ${TODAY}

## ğŸ¯ ä»Šæ—¥é‡ç‚¹

### Morning Review
- [ ] å›é¡¾æ˜¨æ—¥å¾…åŠå®Œæˆæƒ…å†µ
- [ ] æŸ¥çœ‹è‚¡ç¥¨åˆ†ææ¨é€
- [ ] ç¡®è®¤å½“æ—¥ä¼šè®®å®‰æ’

$(get_todos)

### ğŸ“… ä¼šè®®å®‰æ’
å¾…è¡¥å……...

### ğŸ’¡ ä»Šæ—¥çµæ„Ÿ/æƒ³æ³•
å¾…è¡¥å……...

---
*Generated by OpenClaw Auto-Note @ $(date '+%Y-%m-%d %H:%M')*"

    if [ -n "$EXISTING_NOTE" ]; then
        # Append to existing note
        local note_dir=$(dirname "$EXISTING_NOTE")
        local existing_content=$(cat "$EXISTING_NOTE")
        echo "$existing_content

--- Auto-Note Update ---
$content" > "$EXISTING_NOTE"
        echo "âœ… Updated: $(basename "$note_dir")"
        echo "   Appended auto-generated todo list"
    else
        # Create new note
        local next_num=$(find_next_note)
        local note_dir="${OBSIDIAN_VAULT}/n_${next_num}"
        mkdir -p "$note_dir"
        echo "$content" > "$note_dir/content.txt"
        echo "$content" > "$note_dir/snapshot.txt"
        echo "âœ… Created: n_${next_num}"
    fi
}

# Check if already created today, if so append to existing note
EXISTING_NOTE=$(grep -l "^# ${TODAY}$" "$OBSIDIAN_VAULT"/n_*/content.txt 2>/dev/null | head -1)

# Create the note
create_note

echo "ğŸ¯ Daily note created successfully!"
