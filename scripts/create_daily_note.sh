#!/bin/bash
# Obsidian Daily Note Creator (Auto-increment version)
# Runs daily at 8:30 AM
# Creates new note each day with auto-incremented ID

# Configuration
NOTE_DIR="$HOME/.openclaw/workspace/storage/vault/u_1/note"
MEMORY_FILE="/root/.openclaw/workspace/MEMORY.md"
TODAY=$(date +%Y-%m-%d)
YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)

# Extract todos from MEMORY.md
get_todos() {
    echo "## ðŸ“‹ å¾…åŠžäº‹é¡¹"
    echo ""
    echo "### ðŸ”„ æŒç»­è¿›è¡Œ"
    if [ -f "$MEMORY_FILE" ]; then
        grep -A 30 "å¾…åŠžè¿½è¸ª" "$MEMORY_FILE" 2>/dev/null | grep "^- " | sed 's/^- /- [ ] /' | head -10
    fi
    echo ""
    echo "### ðŸ’¼ å·¥ä½œä»»åŠ¡"
    echo "- [ ] ä¸Ž Chapin è·Ÿè¿›æ•°æ®ä¸­å°é¡¹ç›®è¿›å±•"
    echo "- [ ] è”ç³»æ·±åœ³ office çœ‹æˆ¿éœ€æ±‚åé¦ˆ"
    echo "- [ ] è·Ÿè¿› SAP æŽ¥å£å¼€å‘éœ€æ±‚ç¡®è®¤"
    echo "- [ ] ç”¨å‹äº‘ç«¯é¡¹ç›®è¿›åº¦è·Ÿè¿›"
    echo "- [ ] GP% Dashboard å¼€å‘ï¼ˆç­‰å¾… Ken æä¾›åŽ†å²æ•°æ®ï¼‰"
    echo "- [ ] AR Dashboard å¼€å‘ï¼ˆç­‰å¾…æ±‡çŽ‡æ•°æ®ï¼‰"
    echo ""
    echo "### ðŸ“Š è‚¡ç¥¨ç›‘æŽ§"
    echo "- [ ] æ£€æŸ¥æ¯æ—¥è‚¡ç¥¨åˆ†æžæŽ¨é€"
    echo ""
}

# Find next available note ID
get_next_note_id() {
    local max_id=0
    for dir in "$NOTE_DIR"/n_*; do
        if [ -d "$dir" ]; then
            local id=$(basename "$dir" | sed 's/n_//')
            if [[ "$id" =~ ^[0-9]+$ ]] && [ "$id" -gt "$max_id" ]; then
                max_id=$id
            fi
        fi
    done
    echo $((max_id + 1))
}

# Check if today's note already exists
check_today_note() {
    local max_id=0
    for dir in "$NOTE_DIR"/n_*; do
        if [ -d "$dir" ]; then
            local id=$(basename "$dir" | sed 's/n_//')
            if [[ "$id" =~ ^[0-9]+$ ]] && [ "$id" -gt "$max_id" ]; then
                max_id=$id
            fi
        fi
    done

    # Check if today's date matches the latest note's date
    local latest_content="${NOTE_DIR}/n_${max_id}/content.txt"
    if [ -f "$latest_content" ] && grep -q "$TODAY" "$latest_content"; then
        echo "$max_id"
    else
        echo "new"
    fi
}

# Create/update note
create_or_update_note() {
    local note_id=$(check_today_note)
    local note_path="${NOTE_DIR}/n_${note_id}/content.txt"

    local content="# ${TODAY}

## ðŸŽ¯ ä»Šæ—¥é‡ç‚¹

### Morning Review
- [ ] å›žé¡¾æ˜¨æ—¥å¾…åŠžå®Œæˆæƒ…å†µ
- [ ] æŸ¥çœ‹è‚¡ç¥¨åˆ†æžæŽ¨é€
- [ ] ç¡®è®¤å½“æ—¥ä¼šè®®å®‰æŽ’

$(get_todos)

### ðŸ“… ä¼šè®®å®‰æŽ’
å¾…è¡¥å……...

### ðŸ’¡ ä»Šæ—¥çµæ„Ÿ/æƒ³æ³•
å¾…è¡¥å……...

---
*Generated by OpenClaw Auto-Note @ $(date '+%Y-%m-%d %H:%M')*"

    if [ "$note_id" == "new" ]; then
        # Create new note
        note_id=$(get_next_note_id)
        note_path="${NOTE_DIR}/n_${note_id}/content.txt"
        mkdir -p "${NOTE_DIR}/n_${note_id}"
        echo "$content" > "$note_path"
        echo "$content" > "${NOTE_DIR}/n_${note_id}/snapshot.txt"
        echo "âœ… Created: n_${note_id} for ${TODAY}"
    else
        # Append to existing note
        local existing_content=$(cat "$note_path")
        echo "$existing_content

--- Auto-Note Update ---
$content" > "$note_path"
        echo "âœ… Updated: n_${note_id} for ${TODAY}"
    fi
}

create_or_update_note
